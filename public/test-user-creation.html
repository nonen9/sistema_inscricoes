<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Cria√ß√£o de Usu√°rio</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 600px; 
            margin: 50px auto; 
            padding: 20px; 
        }
        .form-group { 
            margin-bottom: 15px; 
        }
        label { 
            display: block; 
            margin-bottom: 5px; 
        }
        input, select { 
            width: 100%; 
            padding: 8px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
        }
        button { 
            background: #007cba; 
            color: white; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
        }
        .error { 
            background: #fee; 
            border: 1px solid #fcc; 
            padding: 10px; 
            border-radius: 4px; 
            color: #c00; 
            margin-top: 10px; 
        }
        .success { 
            background: #efe; 
            border: 1px solid #cfc; 
            padding: 10px; 
            border-radius: 4px; 
            color: #060; 
            margin-top: 10px; 
        }
        .log {
            background: #f5f5f5;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 20px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>Teste - Cria√ß√£o de Usu√°rio</h1>
    
    <form id="testForm">
        <div class="form-group">
            <label for="username">Nome de Usu√°rio:</label>
            <input type="text" id="username" name="username" required>
        </div>
        
        <div class="form-group">
            <label for="password">Senha:</label>
            <input type="password" id="password" name="password" required>
        </div>
        
        <div class="form-group">
            <label for="role">Fun√ß√£o:</label>
            <select id="role" name="role">
                <option value="admin">Administrador</option>
                <option value="organizer">Organizador</option>
            </select>
        </div>
        
        <button type="submit" id="submitBtn">Criar Usu√°rio</button>
    </form>
    
    <div id="result"></div>
    <div class="log" id="log"></div>

    <script>
        let logContent = '';
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logContent += `[${timestamp}] ${message}\n`;
            document.getElementById('log').textContent = logContent;
            console.log(message);
        }
        
        function showResult(message, isError = false) {
            const resultDiv = document.getElementById('result');
            resultDiv.className = isError ? 'error' : 'success';
            resultDiv.textContent = message;
        }
        
        function getAuthToken() {
            return localStorage.getItem('authToken');
        }
        
        function getAuthHeaders() {
            const token = getAuthToken();
            return token ? { 'Authorization': `Bearer ${token}` } : {};
        }
        
        async function testUserCreation(username, password, role) {
            log('üîç Iniciando teste de cria√ß√£o de usu√°rio');
            log(`üìã Dados: username=${username}, password=${password}, role=${role}`);
            
            // Check auth token
            const token = getAuthToken();
            log(`üîë Token: ${token ? 'Presente' : 'Ausente'}`);
            
            if (!token) {
                log('‚ùå Token n√£o encontrado no localStorage');
                showResult('Erro: Token de autentica√ß√£o n√£o encontrado. Fa√ßa login primeiro.', true);
                return;
            }
            
            try {
                log('üåê Fazendo requisi√ß√£o POST para /api/admin/users');
                
                const requestData = {
                    username: username,
                    password: password,
                    role: role
                };
                
                log(`üì§ Enviando dados: ${JSON.stringify(requestData)}`);
                
                const response = await fetch('/api/admin/users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify(requestData)
                });
                
                log(`üì° Status da resposta: ${response.status}`);
                log(`üìã Headers da resposta: ${JSON.stringify([...response.headers.entries()])}`);
                
                const result = await response.json();
                log(`üì• Resposta recebida: ${JSON.stringify(result, null, 2)}`);
                
                if (response.ok) {
                    log('‚úÖ Usu√°rio criado com sucesso!');
                    showResult('Usu√°rio criado com sucesso!', false);
                } else {
                    log(`‚ùå Erro: ${result.error}`);
                    showResult(`Erro: ${result.error}`, true);
                }
            } catch (error) {
                log(`‚ùå Erro de conex√£o: ${error.message}`);
                log(`‚ùå Stack trace: ${error.stack}`);
                showResult(`Erro de conex√£o: ${error.message}`, true);
            }
        }
        
        document.getElementById('testForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const role = document.getElementById('role').value;
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Criando...';
            
            await testUserCreation(username, password, role);
            
            submitBtn.disabled = false;
            submitBtn.textContent = 'Criar Usu√°rio';
        });
        
        // Log initial info
        log('üöÄ P√°gina de teste carregada');
        log(`üåç URL atual: ${window.location.href}`);
        log(`üîë Token presente: ${getAuthToken() ? 'Sim' : 'N√£o'}`);
        
        // Check localStorage content
        log('üì¶ Conte√∫do do localStorage:');
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            const value = localStorage.getItem(key);
            log(`  ${key}: ${value}`);
        }
    </script>
</body>
</html>
